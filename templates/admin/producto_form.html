{% extends "base.html" %}

{% block content %}
<style>
    /* Estilos para las miniaturas */
    .preview-item {
        position: relative; width: 80px; height: 80px;
        border: 1px solid #2ecc71; border-radius: 4px;
        overflow: hidden; background-color: #000;
    }
    .preview-item img { width: 100%; height: 100%; object-fit: cover; }
    .btn-remove-img {
        position: absolute; top: 0; right: 0;
        background: rgba(231, 76, 60, 0.9); color: white; border: none;
        width: 20px; height: 20px; cursor: pointer;
        display: flex; align-items: center; justify-content: center;
        font-weight: bold; z-index: 10;
    }
</style>

<!-- Usamos la clase nueva 'admin-form-card' para mantener la estética -->
<div class="admin-form-card">
    
    <div style="display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #333; padding-bottom: 15px; margin-bottom: 25px;">
        <h2 style="margin: 0; color: white;">{{ "Editar" if producto else "Nuevo" }} Producto</h2>
        <a href="{{ url_for('productos.listar_productos') }}" style="color: #ccc; text-decoration: none;">
            <i class="fas fa-times"></i> Cancelar
        </a>
    </div>
    
    <form method="POST" enctype="multipart/form-data" id="productForm">
        
        <!-- Nombre -->
        <div style="margin-bottom: 20px;">
            <label style="display:block; margin-bottom:8px; color: #aaa;">Nombre del Producto</label>
            <input type="text" name="nombre" value="{{ producto.nombre if producto else '' }}" required 
                   style="width: 100%; padding: 12px; background: #0b1116; border: 1px solid #333; color: white; border-radius: 4px; box-sizing: border-box;">
        </div>

        <!-- Categoría y Precio -->
        <div style="display: flex; gap: 20px; flex-wrap: wrap; margin-bottom: 20px;">
            <div style="flex: 1;">
                <label style="display:block; margin-bottom:8px; color: var(--kaitek-green);">Categoría</label>
                <select name="categoria" required style="width: 100%; padding: 12px; background: #0b1116; border: 1px solid #333; color: white; border-radius: 4px; box-sizing: border-box;">
                    <option value="" disabled selected>Seleccionar...</option>
                    {% for c in categorias %}
                        <option value="{{ c.nombre }}" {% if producto and producto.categoria == c.nombre %}selected{% endif %}>{{ c.nombre }}</option>
                    {% else %}
                        <option value="" disabled>No hay categorías</option>
                    {% endfor %}
                </select>
            </div>
            
            <div style="flex: 1;">
                <label style="display:block; margin-bottom:8px; color: #aaa;">Precio Ref.</label>
                <input type="text" name="precio" value="{{ producto.precio if producto else '' }}" placeholder="Ej: A cotizar"
                       style="width: 100%; padding: 12px; background: #0b1116; border: 1px solid #333; color: white; border-radius: 4px; box-sizing: border-box;">
            </div>
        </div>

        <!-- Descripción -->
        <div style="margin-bottom: 20px;">
            <label style="display:block; margin-bottom:8px; color: #aaa;">Descripción Técnica</label>
            <textarea name="descripcion" rows="5" required 
                      style="width: 100%; padding: 12px; background: #0b1116; border: 1px solid #333; color: white; border-radius: 4px; font-family: sans-serif; box-sizing: border-box;">{{ producto.descripcion if producto else '' }}</textarea>
        </div>

        <!-- Imágenes -->
        <div style="margin-top: 30px; padding: 20px; background: rgba(0,0,0,0.2); border-radius: 8px;">
            <label style="display:block; margin-bottom:15px; color: var(--kaitek-green);">Imágenes</label>
            
            <!-- Existentes -->
            {% if producto and producto.imagenes %}
            <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 15px;">
                {% for img_url in producto.imagenes %}
                <div class="preview-item">
                    <img src="{{ img_url }}">
                    <a href="{{ url_for('productos.eliminar_imagen', id=producto._id, url=img_url) }}" 
                       class="btn-remove-img" onclick="return confirm('¿Borrar?');">&times;</a>
                </div>
                {% endfor %}
            </div>
            {% endif %}

            <!-- Nuevas -->
            <input type="file" name="imagenes" id="file-input" multiple style="display: none;">
            <button type="button" onclick="document.getElementById('file-input').click()" 
                    style="background: #333; color: white; border: 1px dashed #666; padding: 10px; width: 100%; cursor: pointer; border-radius: 4px;">
                <i class="fas fa-camera"></i> Agregar Fotos
            </button>
            <p id="counter-text" style="font-size: 0.8rem; color: #888; margin-top: 10px;"></p>
            <div id="preview-container" style="display: flex; gap: 10px; flex-wrap: wrap; margin-top: 10px;"></div>
        </div>

        <!-- Botón Guardar -->
        <div style="margin-top: 30px;">
            <button type="submit" class="btn-contacto" style="width: 100%; padding: 15px; font-size: 1.1rem; border: none; cursor: pointer;">
                Guardar Cambios
            </button>
        </div>
    </form>
</div>

<script>
    let storedFiles = [];
    const input = document.getElementById('file-input');
    const container = document.getElementById('preview-container');
    const counter = document.getElementById('counter-text');

    input.addEventListener('change', function(e) {
        const files = e.target.files;
        for (let i = 0; i < files.length; i++) { storedFiles.push(files[i]); }
        updatePreview(); updateInputFiles();
    });

    function updatePreview() {
        container.innerHTML = "";
        if (storedFiles.length > 0) counter.innerText = `${storedFiles.length} fotos seleccionadas`;
        else counter.innerText = "";

        storedFiles.forEach((file, index) => {
            const reader = new FileReader();
            reader.onload = function(e) {
                const div = document.createElement('div');
                div.className = 'preview-item';
                div.innerHTML = `<img src="${e.target.result}"><button type="button" class="btn-remove-img" onclick="removeFile(${index})">&times;</button>`;
                container.appendChild(div);
            }
            reader.readAsDataURL(file);
        });
    }

    function removeFile(index) {
        storedFiles.splice(index, 1); updatePreview(); updateInputFiles();
    }

    function updateInputFiles() {
        const dataTransfer = new DataTransfer();
        storedFiles.forEach(file => { dataTransfer.items.add(file); });
        input.files = dataTransfer.files;
    }
</script>
{% endblock %}